- id: heizung_buero_tag
  alias: "Heizung Büro - Tagesmodus"
  description: "Büro auf eingestellte Tagestemperatur von 7:00 bis 22:00"
  trigger:
    - platform: time
      at: "07:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_buero_tag_temperatur
      id: temp_changed
  condition:
    - condition: time
      after: "07:00:00"
      before: "22:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_buro
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_buro
      data:
        temperature: "{{ states('input_number.heizung_buero_tag_temperatur') | float }}"

- id: heizung_buero_nacht
  alias: "Heizung Büro - Nachtmodus"
  description: "Büro auf eingestellte Nachttemperatur ab 22:00"
  trigger:
    - platform: time
      at: "22:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_buero_nacht_temperatur
      id: temp_changed
  condition:
    - condition: or
      conditions:
        - condition: time
          after: "22:00:00"
        - condition: time
          before: "07:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_buro
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_buro
      data:
        temperature: "{{ states('input_number.heizung_buero_nacht_temperatur') | float }}"

- id: heizung_bad_tag
  alias: "Heizung Bad - Tagesmodus"
  description: "Bad auf eingestellte Tagestemperatur von 7:00 bis 22:00"
  trigger:
    - platform: time
      at: "07:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_bad_tag_temperatur
      id: temp_changed
  condition:
    - condition: time
      after: "07:00:00"
      before: "22:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_bad
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_bad
      data:
        temperature: "{{ states('input_number.heizung_bad_tag_temperatur') | float }}"

- id: heizung_bad_nacht
  alias: "Heizung Bad - Nachtmodus"
  description: "Bad auf eingestellte Nachttemperatur ab 22:00"
  trigger:
    - platform: time
      at: "22:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_bad_nacht_temperatur
      id: temp_changed
  condition:
    - condition: or
      conditions:
        - condition: time
          after: "22:00:00"
        - condition: time
          before: "07:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_bad
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_bad
      data:
        temperature: "{{ states('input_number.heizung_bad_nacht_temperatur') | float }}"

- id: heizung_waschraum_tag
  alias: "Heizung Waschraum - Tagesmodus"
  description: "Waschraum auf eingestellte Tagestemperatur von 7:00 bis 22:00"
  trigger:
    - platform: time
      at: "07:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_waschraum_tag_temperatur
      id: temp_changed
  condition:
    - condition: time
      after: "07:00:00"
      before: "22:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_waschraum
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_waschraum
      data:
        temperature: "{{ states('input_number.heizung_waschraum_tag_temperatur') | float }}"

- id: heizung_waschraum_nacht
  alias: "Heizung Waschraum - Nachtmodus"
  description: "Waschraum auf eingestellte Nachttemperatur ab 22:00"
  trigger:
    - platform: time
      at: "22:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_waschraum_nacht_temperatur
      id: temp_changed
  condition:
    - condition: or
      conditions:
        - condition: time
          after: "22:00:00"
        - condition: time
          before: "07:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.heizung_waschraum
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id: climate.heizung_waschraum
      data:
        temperature: "{{ states('input_number.heizung_waschraum_nacht_temperatur') | float }}"

- id: heizung_kueche_tag
  alias: "Heizung Küche - Tagesmodus"
  description: "Küche (alle 3 Thermostate) auf eingestellte Tagestemperatur von 7:00 bis 22:00"
  trigger:
    - platform: time
      at: "07:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_kueche_tag_temperatur
      id: temp_changed
  condition:
    - condition: time
      after: "07:00:00"
      before: "22:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.heizung_kuche_l
          - climate.heizung_kuche_m
          - climate.heizung_kuche_r
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.heizung_kuche_l
          - climate.heizung_kuche_m
          - climate.heizung_kuche_r
      data:
        temperature: "{{ states('input_number.heizung_kueche_tag_temperatur') | float }}"

- id: heizung_kueche_nacht
  alias: "Heizung Küche - Nachtmodus"
  description: "Küche (alle 3 Thermostate) auf eingestellte Nachttemperatur ab 22:00"
  trigger:
    - platform: time
      at: "22:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_kueche_nacht_temperatur
      id: temp_changed
  condition:
    - condition: or
      conditions:
        - condition: time
          after: "22:00:00"
        - condition: time
          before: "07:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.heizung_kuche_l
          - climate.heizung_kuche_m
          - climate.heizung_kuche_r
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.heizung_kuche_l
          - climate.heizung_kuche_m
          - climate.heizung_kuche_r
      data:
        temperature: "{{ states('input_number.heizung_kueche_nacht_temperatur') | float }}"

- id: heizung_sauna_tag
  alias: "Heizung Sauna - Tagesmodus"
  description: "Sauna (beide Thermostate) auf eingestellte Tagestemperatur von 7:00 bis 22:00"
  trigger:
    - platform: time
      at: "07:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_sauna_tag_temperatur
      id: temp_changed
  condition:
    - condition: time
      after: "07:00:00"
      before: "22:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.heizung_sauna_l
          - climate.heizung_sauna_r
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.heizung_sauna_l
          - climate.heizung_sauna_r
      data:
        temperature: "{{ states('input_number.heizung_sauna_tag_temperatur') | float }}"

- id: heizung_sauna_nacht
  alias: "Heizung Sauna - Nachtmodus"
  description: "Sauna (beide Thermostate) auf eingestellte Nachttemperatur ab 22:00"
  trigger:
    - platform: time
      at: "22:00:00"
      id: time_trigger
    - platform: homeassistant
      event: start
      id: startup_trigger
    - platform: time_pattern
      minutes: "/5"
      id: retry_trigger
    - platform: state
      entity_id: input_number.heizung_sauna_nacht_temperatur
      id: temp_changed
  condition:
    - condition: or
      conditions:
        - condition: time
          after: "22:00:00"
        - condition: time
          before: "07:00:00"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id:
          - climate.heizung_sauna_l
          - climate.heizung_sauna_r
      data:
        hvac_mode: auto
    - delay:
        milliseconds: 500
    - service: climate.set_temperature
      target:
        entity_id:
          - climate.heizung_sauna_l
          - climate.heizung_sauna_r
      data:
        temperature: "{{ states('input_number.heizung_sauna_nacht_temperatur') | float }}"

# Globale Temperatur-Synchronisation
- id: heizung_alle_tag_sync
  alias: "Heizung Alle - Tag Temperatur Sync"
  description: "Synchronisiert die globale Tagestemperatur auf alle Thermostate"
  trigger:
    - platform: state
      entity_id: input_number.heizung_alle_tag_temperatur
  action:
    - service: input_number.set_value
      target:
        entity_id:
          - input_number.heizung_buero_tag_temperatur
          - input_number.heizung_bad_tag_temperatur
          - input_number.heizung_waschraum_tag_temperatur
          - input_number.heizung_kueche_tag_temperatur
          - input_number.heizung_sauna_tag_temperatur
      data:
        value: "{{ states('input_number.heizung_alle_tag_temperatur') | float }}"

- id: heizung_alle_nacht_sync
  alias: "Heizung Alle - Nacht Temperatur Sync"
  description: "Synchronisiert die globale Nachttemperatur auf alle Thermostate"
  trigger:
    - platform: state
      entity_id: input_number.heizung_alle_nacht_temperatur
  action:
    - service: input_number.set_value
      target:
        entity_id:
          - input_number.heizung_buero_nacht_temperatur
          - input_number.heizung_bad_nacht_temperatur
          - input_number.heizung_waschraum_nacht_temperatur
          - input_number.heizung_kueche_nacht_temperatur
          - input_number.heizung_sauna_nacht_temperatur
      data:
        value: "{{ states('input_number.heizung_alle_nacht_temperatur') | float }}"

# Interne Thermostat-Schedules synchronisieren (Avatto TRV06_1)
- id: heizung_kueche_schedule_sync
  alias: "Heizung Küche - Interne Schedules Sync"
  description: "Synchronisiert die internen Thermostat-Schedules mit den HA-Einstellungen"
  trigger:
    - platform: state
      entity_id:
        - input_number.heizung_kueche_tag_temperatur
        - input_number.heizung_kueche_nacht_temperatur
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - variables:
        tag_temp: "{{ states('input_number.heizung_kueche_tag_temperatur') | round(0) | int }}"
        nacht_temp: "{{ states('input_number.heizung_kueche_nacht_temperatur') | round(0) | int }}"
        schedule: "00:00/{{ nacht_temp }} 07:00/{{ tag_temp }} 16:00/{{ tag_temp }} 22:00/{{ nacht_temp }}"
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Küche L/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
    - delay:
        milliseconds: 500
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Küche M/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
    - delay:
        milliseconds: 500
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Küche R/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
  mode: restart

- id: heizung_sauna_schedule_sync
  alias: "Heizung Sauna - Interne Schedules Sync"
  description: "Synchronisiert die internen Thermostat-Schedules mit den HA-Einstellungen"
  trigger:
    - platform: state
      entity_id:
        - input_number.heizung_sauna_tag_temperatur
        - input_number.heizung_sauna_nacht_temperatur
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - variables:
        tag_temp: "{{ states('input_number.heizung_sauna_tag_temperatur') | round(0) | int }}"
        nacht_temp: "{{ states('input_number.heizung_sauna_nacht_temperatur') | round(0) | int }}"
        schedule: "00:00/{{ nacht_temp }} 07:00/{{ tag_temp }} 16:00/{{ tag_temp }} 22:00/{{ nacht_temp }}"
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Sauna L/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
    - delay:
        milliseconds: 500
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Sauna R/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
  mode: restart

- id: heizung_buero_schedule_sync
  alias: "Heizung Büro - Interne Schedules Sync"
  description: "Synchronisiert die internen Thermostat-Schedules mit den HA-Einstellungen"
  trigger:
    - platform: state
      entity_id:
        - input_number.heizung_buero_tag_temperatur
        - input_number.heizung_buero_nacht_temperatur
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - variables:
        tag_temp: "{{ states('input_number.heizung_buero_tag_temperatur') | round(0) | int }}"
        nacht_temp: "{{ states('input_number.heizung_buero_nacht_temperatur') | round(0) | int }}"
        schedule: "00:00/{{ nacht_temp }} 07:00/{{ tag_temp }} 12:00/{{ tag_temp }} 16:00/{{ tag_temp }} 20:00/{{ tag_temp }} 22:00/{{ nacht_temp }}"
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Büro/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
  mode: restart

- id: heizung_bad_schedule_sync
  alias: "Heizung Bad - Interne Schedules Sync"
  description: "Synchronisiert die internen Thermostat-Schedules mit den HA-Einstellungen"
  trigger:
    - platform: state
      entity_id:
        - input_number.heizung_bad_tag_temperatur
        - input_number.heizung_bad_nacht_temperatur
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - variables:
        tag_temp: "{{ states('input_number.heizung_bad_tag_temperatur') | round(0) | int }}"
        nacht_temp: "{{ states('input_number.heizung_bad_nacht_temperatur') | round(0) | int }}"
        schedule: "00:00/{{ nacht_temp }} 07:00/{{ tag_temp }} 16:00/{{ tag_temp }} 22:00/{{ nacht_temp }}"
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Bad/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
  mode: restart

- id: heizung_waschraum_schedule_sync
  alias: "Heizung Waschraum - Interne Schedules Sync"
  description: "Synchronisiert die internen Thermostat-Schedules mit den HA-Einstellungen"
  trigger:
    - platform: state
      entity_id:
        - input_number.heizung_waschraum_tag_temperatur
        - input_number.heizung_waschraum_nacht_temperatur
    - platform: homeassistant
      event: start
  action:
    - delay:
        seconds: 30
    - variables:
        tag_temp: "{{ states('input_number.heizung_waschraum_tag_temperatur') | round(0) | int }}"
        nacht_temp: "{{ states('input_number.heizung_waschraum_nacht_temperatur') | round(0) | int }}"
        schedule: "00:00/{{ nacht_temp }} 07:00/{{ tag_temp }} 16:00/{{ tag_temp }} 22:00/{{ nacht_temp }}"
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Heizung Waschraum/set"
        payload: >
          {"schedule_monday": "{{ schedule }}", "schedule_tuesday": "{{ schedule }}", "schedule_wednesday": "{{ schedule }}", "schedule_thursday": "{{ schedule }}", "schedule_friday": "{{ schedule }}", "schedule_saturday": "{{ schedule }}", "schedule_sunday": "{{ schedule }}"}
  mode: restart

- id: 'fritz_auto_reload'
  alias: 'Fritz!Box Integration Auto-Reload'
  description: 'Lädt die Fritz!Box Integration automatisch neu wenn die Verbindung verloren geht'
  trigger:
    - platform: homeassistant
      event: start
    - platform: time_pattern
      minutes: "/5"
    - platform: state
      entity_id: binary_sensor.fritz_box_7530_ax_verbindung
      to: "unavailable"
      for:
        minutes: 2
  condition:
    - condition: state
      entity_id: binary_sensor.fritz_box_7530_ax_verbindung
      state: "unavailable"
  action:
    - delay:
        seconds: 30
    - service: homeassistant.reload_config_entry
      data:
        entry_id: 01KDD3ZC8W9XFFCHHDTW5VDSZ7
    - service: homeassistant.reload_config_entry
      data:
        entry_id: 01K9FVBT4VJMV74CVE6YGQ1S8J
    - service: persistent_notification.create
      data:
        title: 'Fritz!Box Integration'
        message: 'Fritz!Box Integration wurde automatisch neu geladen wegen Verbindungsverlust'
  mode: single

# Büro LED Dimmer - Drehknopf
- id: buero_dimmer_brightness_up
  alias: "Büro Dimmer - Heller"
  description: "Erhöht Helligkeit aller Büro LEDs beim Rechtsdrehen"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Büro/action"
      payload: "rotate_right"
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.buro_leds
          - light.h619a
          - light.h6061
          - light.wled_3
          - light.wled_4
      data:
        brightness_step_pct: 10

- id: buero_dimmer_brightness_down
  alias: "Büro Dimmer - Dunkler"
  description: "Verringert Helligkeit aller Büro LEDs beim Linksdrehen"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Büro/action"
      payload: "rotate_left"
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.buro_leds
          - light.h619a
          - light.h6061
          - light.wled_3
          - light.wled_4
      data:
        brightness_step_pct: -10

- id: buero_dimmer_toggle
  alias: "Büro Dimmer - An/Aus"
  description: "Schaltet alle Büro LEDs beim Drücken"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Büro/action"
      payload: "single"
  action:
    - service: light.toggle
      target:
        entity_id:
          - light.buro_leds
          - light.h619a
          - light.h6061
          - light.wled_3
          - light.wled_4

# Flur Dimmer - Drehknopf
- id: flur_dimmer_brightness_up
  alias: "Flur Dimmer - Heller"
  description: "Erhöht Helligkeit beim Rechtsdrehen"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Flur/action"
      payload: "rotate_right"
  action:
    - service: light.turn_on
      target:
        entity_id: light.dimmer_flur
      data:
        brightness_step_pct: 10

- id: flur_dimmer_brightness_down
  alias: "Flur Dimmer - Dunkler"
  description: "Verringert Helligkeit beim Linksdrehen"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Flur/action"
      payload: "rotate_left"
  action:
    - service: light.turn_on
      target:
        entity_id: light.dimmer_flur
      data:
        brightness_step_pct: -10

- id: flur_dimmer_toggle
  alias: "Flur Dimmer - An/Aus"
  description: "Schaltet Flur Licht beim Drücken"
  trigger:
    - platform: mqtt
      topic: "zigbee2mqtt/Knopf Flur/action"
      payload: "single"
  action:
    - service: light.toggle
      target:
        entity_id: light.dimmer_flur
